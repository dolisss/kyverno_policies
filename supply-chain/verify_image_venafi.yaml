apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-image-venafi-key
  annotations:
    pod-policies.kyverno.io/autogen-controllers: none
    policies.kyverno.io/category: Image Verification
    policies.kyverno.io/severity: medium
    policies.kyverno.io/scored: "yes"
    policies.kyverno.io/description: Using the Cosign project, OCI images may be
      signed to ensure supply chain security is maintained. Those signatures can
      be verified before pulling into a cluster. This policy checks the
      signature of an image repo called ghcr.io/kyverno/test-verify-image to
      ensure it has been signed by verifying its signature against the provided
      public key. This policy serves as an illustration for how to configure a
      similar rule and will require replacing with your image(s) and keys.
    venafipkcs11cert84e61ec80: "{ venafi: demoaccount1, label:
      Sample-Development-Environment, type: certificate }"
spec:
  validationFailureAction: enforce
  background: false
  webhookTimeoutSeconds: 30
  failurePolicy: Fail
  rules:
    - name: check-image-venafi-key
      context:
        - name: venaficonfigmap
          configMap:
            name: venaficm
            namespace: nirmata-venafi-adapter
      match:
        resources:
          kinds:
            - Pod
      verifyImages:
        - imageReferences:
            - docker.io/*
          attestors:
            - count: 1
              entries:
                - certificates:
                    certChain: "{{venaficonfigmap.data.key1}}"
